import SwiftUI

/// åˆ†äº«æµ·æŠ¥è§†å›¾
/// ç”¨äºç”ŸæˆåŒ…å«ç”¨æˆ·ä¿¡æ¯å’Œå“ç‰Œå…ƒç´ çš„åˆ†äº«æµ·æŠ¥
struct SharePosterView: View {
    // MARK: - å±æ€§
    
    /// ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
    var isUserLoggedIn: Bool
    
    /// ç”¨æˆ·åç§°
    var userName: String?
    
    /// ç”¨æˆ·å¤´åƒ
    var userAvatar: UIImage?
    
    /// ç›®æ ‡å¯¹è±¡
    var goal: Goal?
    
    /// è‡ªå®šä¹‰å†…å®¹è§†å›¾
    var contentView: AnyView?
    
    // æ·»åŠ è°ƒè¯•æ ‡è®°
    @State private var logoLoadFailed = false
    @State private var companyLogoLoadFailed = false
    
    // MARK: - åˆå§‹åŒ–æ–¹æ³•
    
    /// åˆ›å»ºåˆ†äº«æµ·æŠ¥è§†å›¾
    /// - Parameters:
    ///   - isUserLoggedIn: ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
    ///   - userName: ç”¨æˆ·åç§°ï¼Œæœªç™»å½•ç”¨æˆ·å¯ä¸ºnil
    ///   - userAvatar: ç”¨æˆ·å¤´åƒï¼Œæœªç™»å½•ç”¨æˆ·å¯ä¸ºnil
    ///   - goal: ç›®æ ‡å¯¹è±¡ï¼Œç”¨äºå±•ç¤ºç›®æ ‡ä¿¡æ¯
    ///   - contentView: è‡ªå®šä¹‰å†…å®¹è§†å›¾ï¼Œè‹¥æä¾›åˆ™ä¼˜å…ˆä½¿ç”¨
    init(isUserLoggedIn: Bool, userName: String? = nil, userAvatar: UIImage? = nil, goal: Goal? = nil, contentView: AnyView? = nil) {
        self.isUserLoggedIn = isUserLoggedIn
        self.userName = userName
        self.userAvatar = userAvatar
        self.goal = goal
        self.contentView = contentView
    }
    
    // MARK: - è®¡ç®—å±æ€§
    
    /// æ˜¾ç¤ºçš„ç”¨æˆ·å
    private var displayName: String {
        if isUserLoggedIn, let name = userName, !name.isEmpty {
            return name
        }
        return "æœªç™»å½•ç”¨æˆ·"
    }
    
    /// æ˜¾ç¤ºçš„å¤´åƒ
    private var displayAvatar: Image {
        if isUserLoggedIn, let avatar = userAvatar {
            return Image(uiImage: avatar)
        }
        // ä½¿ç”¨SF Symbolä½œä¸ºå¤‡é€‰
        return logoLoadFailed ? Image(systemName: "person.circle.fill") : Image("Logo")
    }
    
    // å­ä»»åŠ¡é¢œè‰²æ•°ç»„
    private let taskColors: [Color] = [
        .blue, .green, .orange, .purple, .pink, .yellow, .teal, .indigo
    ]
    
    // MARK: - è§†å›¾ç»„ä»¶
    
    /// ç”¨æˆ·å¤´åƒè§†å›¾
    private var userAvatarView: some View {
        displayAvatar
            .resizable()
            .scaledToFill()
            .frame(width: 40, height: 40)
            .clipShape(Circle())
            .overlay(
                Circle()
                    .stroke(Color.white.opacity(0.3), lineWidth: 1)
            )
    }
    
    /// æ£€æŸ¥Logoæ˜¯å¦åŠ è½½æˆåŠŸ
    private func checkLogoLoading() {
        if !isUserLoggedIn && userAvatar == nil {
            if UIImage(named: "Logo") == nil {
                logoLoadFailed = true
                print("âš ï¸ Logoå›¾åƒåŠ è½½å¤±è´¥")
            } else {
                print("âœ… Logoå›¾åƒåŠ è½½æˆåŠŸ")
            }
        }
    }
    
    /// å…¬å¸Logoè§†å›¾
    private var companyLogoView: some View {
        Group {
            if companyLogoLoadFailed {
                // ä½¿ç”¨SF Symbolä½œä¸ºå¤‡é€‰
                Image(systemName: "building.2.fill")
                    .resizable()
                    .scaledToFit()
                    .frame(height: 30)
                    .foregroundColor(.white)
            } else {
                Image("Logo")
                    .resizable()
                    .scaledToFit()
                    .frame(height: 30)
            }
        }
    }
    
    /// æ£€æŸ¥å…¬å¸Logoæ˜¯å¦åŠ è½½æˆåŠŸ
    private func checkCompanyLogoLoading() {
        if UIImage(named: "Logo") == nil {
            companyLogoLoadFailed = true
            print("âš ï¸ Logoå›¾åƒåŠ è½½å¤±è´¥")
        } else {
            print("âœ… Logoå›¾åƒåŠ è½½æˆåŠŸ")
        }
    }
    
    /// è‡ªå®šä¹‰æ ¼å¼åŒ–æ—¥æœŸ
    private func formatDate(_ date: Date) -> String {
        let formatter = DateFormatter()
        formatter.dateFormat = "MMæœˆddæ—¥"
        return formatter.string(from: date)
    }
    
    /// é¡¶éƒ¨å…¬å¸æ ‡è¯†æ 
    private var companyHeader: some View {
        HStack(spacing: 8) {
            companyLogoView
                .frame(width: 30, height: 30)
            
            Text("å¤§project, ç‚¹æ»´å‰è¡Œ")
                .font(.system(size: 16, weight: .medium))
                .foregroundColor(.white)
            
            Spacer()
        }
        .padding(.horizontal, 15)
        .padding(.vertical, 10)
    }
    
    /// æµ·æŠ¥æ ‡é¢˜
    private var posterTitle: some View {
        Text("æˆ‘åˆè§£é”äº†ä¸€ä¸ªç›®æ ‡")
            .font(.system(size: 32, weight: .bold))
            .foregroundColor(.white)
            .padding(.top, 30)
            .padding(.bottom, 50)
            .fixedSize(horizontal: false, vertical: true) // ç¡®ä¿æ–‡æœ¬èƒ½å¤Ÿè‡ªé€‚åº”é«˜åº¦
    }
    
    /// è‡ªå®šä¹‰å†…å®¹è§†å›¾çš„åŒ…è£…
    @ViewBuilder
    private var customContentWrapper: some View {
        if let customView = contentView {
            customView
                .fixedSize(horizontal: false, vertical: true) // ç¡®ä¿è‡ªå®šä¹‰å†…å®¹èƒ½å¤Ÿè‡ªé€‚åº”é«˜åº¦
                .padding(.horizontal)
        } else {
            EmptyView()
        }
    }
    
    /// ç›®æ ‡ä½¿ç”¨æ—¶é—´æ–‡æœ¬
    @ViewBuilder
    private func goalTimeText(_ goal: Goal) -> some View {
        if let startDate = goal.startExecutionDate,
           let endDate = goal.completedDate {
            let diff = Calendar.current.dateComponents([.day, .hour, .minute], from: startDate, to: endDate)
            
            let days = diff.day ?? 0
            let hours = diff.hour ?? 0
            let minutes = diff.minute ?? 0
            
            if days > 0 {
                Text("\(days)å¤©")
                    .font(.system(size: 16, weight: .bold))
                    .foregroundColor(.white)
            } else if hours > 0 {
                Text("\(hours)å°æ—¶")
                    .font(.system(size: 16, weight: .bold))
                    .foregroundColor(.white)
            } else {
                Text("\(minutes)åˆ†é’Ÿ")
                    .font(.system(size: 16, weight: .bold))
                    .foregroundColor(.white)
            }
        } else {
            Text("æœªçŸ¥")
                .font(.system(size: 16, weight: .bold))
                .foregroundColor(.white)
        }
    }
    
    /// åˆ›å»ºåŸºäºç›®æ ‡çš„ä¿¡æ¯è§†å›¾
    @ViewBuilder
    private var targetGoalInfoView: some View {
        if let goal = goal {
            ZStack {
                // ä¸­å¤®åœ†å½¢ - æ€»æ—¶é—´ç»Ÿè®¡
                Circle()
                    .fill(Color.white.opacity(0.2))
                    .frame(width: 120, height: 120)
                    .overlay(
                        VStack(spacing: 4) {
                            Text("æ€»ä½¿ç”¨æ—¶é—´")
                                .font(.system(size: 14))
                                .foregroundColor(.white)
                            
                            goalTimeText(goal)
                        }
                    )
                
                // å­ä»»åŠ¡åˆ†å¸ƒå›¾
                ForEach(0..<min(goal.subTasks.count, 8), id: \.self) { index in
                    let subTask = goal.subTasks[index]
                    let angle = Double(index) * (360.0 / Double(min(goal.subTasks.count, 8)))
                    let radius: CGFloat = 150
                    
                    let xPos = sin(angle * .pi / 180) * radius
                    let yPos = -cos(angle * .pi / 180) * radius
                    
                    ZStack {
                        Circle()
                            .fill(taskColors[index % taskColors.count].opacity(0.7))
                            .frame(width: 70, height: 70)
                            .overlay(
                                VStack(spacing: 2) {
                                    // æ˜¾ç¤ºå­ä»»åŠ¡åºå·
                                    Circle()
                                        .fill(Color.white)
                                        .frame(width: 20, height: 20)
                                        .overlay(
                                            Text("\(index + 1)")
                                                .font(.system(size: 12, weight: .bold))
                                                .foregroundColor(taskColors[index % taskColors.count])
                                        )
                                    
                                    // æ˜¾ç¤ºå­ä»»åŠ¡åç§°ï¼ˆæˆªæ–­ï¼‰
                                    let title = subTask.title.count > 4 ? String(subTask.title.prefix(4)) + "..." : subTask.title
                                    Text(title)
                                        .font(.system(size: 12))
                                        .foregroundColor(.white)
                                        .lineLimit(1)
                                    
                                    // æ˜¾ç¤ºç”¨æ—¶
                                    Text("\(subTask.estimatedDays)å¤©")
                                        .font(.system(size: 10))
                                        .foregroundColor(.white.opacity(0.8))
                                }
                            )
                    }
                    .offset(x: xPos, y: yPos)
                }
            }
            .frame(height: 350)
            .fixedSize(horizontal: false, vertical: true) // ç¡®ä¿å†…å®¹èƒ½å¤Ÿè‡ªé€‚åº”é«˜åº¦
        } else {
            // å¦‚æœæ²¡æœ‰ç›®æ ‡ï¼Œæ˜¾ç¤ºä¸€ä¸ªç©ºè§†å›¾
            EmptyView()
        }
    }
    
    /// ç›®æ ‡ä¿¡æ¯è§†å›¾
    @ViewBuilder
    private var goalInfoView: some View {
        if contentView != nil {
            customContentWrapper
                .padding(.bottom, 20) // æ·»åŠ åº•éƒ¨é—´è·ä½¿è§†å›¾æ›´åŠ ç¾è§‚
        } else if goal != nil {
            targetGoalInfoView
                .padding(.bottom, 20) // æ·»åŠ åº•éƒ¨é—´è·ä½¿è§†å›¾æ›´åŠ ç¾è§‚
        } else {
            // å¦‚æœä¸¤è€…éƒ½æ²¡æœ‰ï¼Œæ˜¾ç¤ºä¸€ä¸ªå ä½è§†å›¾
            VStack {
                Text("æš‚æ— ç›®æ ‡æ•°æ®")
                    .foregroundColor(.white)
                    .padding()
            }
            .frame(minHeight: 200) // ç»™å ä½å†…å®¹ä¸€ä¸ªåˆç†çš„æœ€å°é«˜åº¦
            .padding(.bottom, 20)
        }
    }
    
    /// åº•éƒ¨ç”¨æˆ·ä¿¡æ¯
    private var userFooter: some View {
        HStack {
            // ç”¨æˆ·å¤´åƒ
            Circle()
                .fill(Color.white)
                .frame(width: 50, height: 50)
                .overlay(
                    userAvatarView
                        .frame(width: 40, height: 40)
                )
            
            Text("APP LOGO")
                .font(.system(size: 18, weight: .bold))
                .foregroundColor(.black)
            
            Spacer()
        }
        .padding()
        .background(
            Capsule()
                .fill(Color.white)
        )
        .padding(.horizontal, 20)
        .padding(.bottom, 20)
    }
    
    // MARK: - è§†å›¾ä¸»ä½“
    
    var body: some View {
        GeometryReader { fullGeometry in
            ScrollView {
                ZStack {
                    // èƒŒæ™¯æ¸å˜
                    LinearGradient(
                        gradient: Gradient(colors: [
                            Color.blue.opacity(0.7),
                            Color.blue.opacity(0.9)
                        ]),
                        startPoint: .topLeading,
                        endPoint: .bottomTrailing
                    )
                    .edgesIgnoringSafeArea(.all)
                    
                    // è£…é¥°æ€§åœ†å½¢èƒŒæ™¯ - å›ºå®šä½ç½®çš„è£…é¥°å…ƒç´ 
                    Circle()
                        .fill(Color.blue.opacity(0.3))
                        .frame(width: 300, height: 300)
                        .position(x: fullGeometry.size.width * 0.8, y: 200)
                    
                    Circle()
                        .fill(Color.blue.opacity(0.2))
                        .frame(width: 200, height: 200)
                        .position(x: fullGeometry.size.width * 0.1, y: 600)
                    
                    // ä¸»è¦å†…å®¹
                    VStack(spacing: 0) {
                        // é¡¶éƒ¨å…¬å¸æ ‡è¯†
                        companyHeader
                        
                        // æ ‡é¢˜
                        posterTitle
                        
                        // ç›®æ ‡ä¿¡æ¯åŒºåŸŸ - å®Œå…¨è‡ªé€‚åº”å†…å®¹é«˜åº¦
                        goalInfoView
                            .fixedSize(horizontal: false, vertical: true)
                            .padding(.bottom, 30)
                        
                        Spacer(minLength: 30)
                        
                        // åº•éƒ¨ç”¨æˆ·æ ‡è¯†
                        userFooter
                    }
                    .padding(.vertical)
                }
                .onAppear {
                    print("ğŸ“± SharePosterViewå·²åŠ è½½")
                    checkLogoLoading()
                    checkCompanyLogoLoading()
                }
            }
            .frame(width: 390) // ä¿æŒå›ºå®šå®½åº¦ï¼Œé«˜åº¦è‡ªé€‚åº”
        }
        .frame(width: 390) // å›ºå®šå®½åº¦
    }
}

// MARK: - é¢„è§ˆ
#if DEBUG
struct SharePosterView_Previews: PreviewProvider {
    static var previews: some View {
        let demoView = createDemoSharePosterView()
        return demoView
    }
    
    static func createDemoSharePosterView() -> some View {
        // ç¤ºä¾‹Goal
        let goal = Goal(title: "åˆ¶ä½œä¸€æ¬¾APP", goalDescription: "å®Œæˆä¸€ä¸ªiOSåº”ç”¨å¼€å‘")
        
        // æ·»åŠ ç¤ºä¾‹å­ä»»åŠ¡
        let subTask1 = SubTask(title: "å¯¹è°ˆ", goal: goal, order: 0, estimatedDays: 2)
        let subTask2 = SubTask(title: "æ‰€æœ‰å­ä»»åŠ¡", goal: goal, order: 1, estimatedDays: 3)
        let subTask3 = SubTask(title: "ç ”ç©¶", goal: goal, order: 2, estimatedDays: 1)
        let subTask4 = SubTask(title: "å®Œæˆæ–¹æ¡ˆ", goal: goal, order: 3, estimatedDays: 2)
        let subTask5 = SubTask(title: "æˆæœæäº¤", goal: goal, order: 4, estimatedDays: 1)
        let subTask6 = SubTask(title: "æ‰€æœ‰äº¤ä»˜æ—¶é—´", goal: goal, order: 5, estimatedDays: 3)
        
        goal.subTasks = [subTask1, subTask2, subTask3, subTask4, subTask5, subTask6]
        
        // è®¾ç½®å¼€å§‹å’Œå®Œæˆæ—¶é—´
        let calendar = Calendar.current
        let now = Date()
        let startDate = calendar.date(byAdding: .day, value: -10, to: now)!
        
        // æ‰‹åŠ¨è®¾ç½®Goalçš„å±æ€§
        goal.startExecutionDate = startDate
        goal.completedDate = now
        
        return SharePosterView(
            isUserLoggedIn: false,
            goal: goal
        )
    }
}
#endif 