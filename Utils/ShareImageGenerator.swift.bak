import SwiftUI
import UIKit

/// åˆ†äº«å›¾ç‰‡ç”Ÿæˆå™¨
/// ç”¨äºå°†SwiftUIè§†å›¾è½¬æ¢ä¸ºå¯åˆ†äº«çš„UIImage
struct ShareImageGenerator {
    
    /// å°†SwiftUIè§†å›¾è½¬æ¢ä¸ºUIImageï¼Œæ”¯æŒè‡ªé€‚åº”é«˜åº¦
    /// - Parameters:
    ///   - view: è¦è½¬æ¢çš„SwiftUIè§†å›¾
    ///   - width: å›¾ç‰‡å®½åº¦ï¼Œé»˜è®¤ä¸º390ï¼ˆiPhone 13 Proå®½åº¦ï¼‰
    /// - Returns: ç”Ÿæˆçš„UIImageï¼Œå¦‚æœè½¬æ¢å¤±è´¥åˆ™è¿”å›nil
    static func generateImage(from view: some View, width: CGFloat = 390) -> UIImage? {
        // åŒ…è£…è§†å›¾åœ¨ä¸€ä¸ªScrollViewä¸­ä»¥ç¡®ä¿å†…å®¹å¯ä»¥å®Œå…¨æ˜¾ç¤º
        let wrappedView = AnyView(
            view
                .frame(width: width)
                .fixedSize(horizontal: true, vertical: true)
        )
        
        let controller = UIHostingController(rootView: wrappedView)
        
        // é¦–å…ˆè®¡ç®—è§†å›¾çš„ç†æƒ³å°ºå¯¸
        let targetSize = controller.sizeThatFits(in: CGSize(width: width, height: .greatestFiniteMagnitude))
        
        // ç¡®ä¿æˆ‘ä»¬æœ‰ä¸€ä¸ªåˆç†çš„é«˜åº¦
        var finalHeight = targetSize.height
        if finalHeight < 100 {
            // è®¾ç½®ä¸€ä¸ªæœ€å°é«˜åº¦ä»¥é˜²æ­¢å¤ªå°çš„å›¾ç‰‡
            finalHeight = 800
            print("âš ï¸ è§†å›¾é«˜åº¦å¤ªå°ï¼Œä½¿ç”¨é»˜è®¤é«˜åº¦")
        } else if finalHeight > 10000 {
            // è®¾ç½®ä¸€ä¸ªæœ€å¤§é«˜åº¦ä»¥é˜²æ­¢è¿‡å¤§çš„å›¾ç‰‡
            finalHeight = 10000
            print("âš ï¸ è§†å›¾é«˜åº¦å¤ªå¤§ï¼Œæˆªæ–­åˆ°æœ€å¤§é«˜åº¦")
        }
        
        let finalSize = CGSize(width: width, height: finalHeight)
        
        // é…ç½®è§†å›¾æ§åˆ¶å™¨çš„å°ºå¯¸
        controller.view.frame = CGRect(origin: .zero, size: finalSize)
        controller.view.backgroundColor = .clear
        
        // å¼ºåˆ¶å¸ƒå±€æ›´æ–°
        controller.view.layoutIfNeeded()
        
        // åˆ›å»ºä¸€ä¸ªä¸è§†å›¾å®é™…å¤§å°ç›¸ç¬¦çš„æ¸²æŸ“ä¸Šä¸‹æ–‡
        let renderer = UIGraphicsImageRenderer(size: finalSize)
        let image = renderer.image { context in
            controller.view.drawHierarchy(in: controller.view.bounds, afterScreenUpdates: true)
        }
        
        print("ğŸ“ ç”Ÿæˆå›¾ç‰‡å°ºå¯¸: \(image.size.width) x \(image.size.height)")
        return image
    }
    
    /// åˆ›å»ºå¹¶æ˜¾ç¤ºåˆ†äº«ç•Œé¢
    /// - Parameters:
    ///   - image: è¦åˆ†äº«çš„å›¾ç‰‡
    ///   - sourceRect: åˆ†äº«å¼¹å‡ºæ¡†çš„æ¥æºä½ç½®ï¼ˆiPadä¸Šéœ€è¦ï¼‰
    ///   - sourceView: åˆ†äº«å¼¹å‡ºæ¡†çš„æ¥æºè§†å›¾ï¼ˆiPadä¸Šéœ€è¦ï¼‰
    ///   - completion: åˆ†äº«å®Œæˆåçš„å›è°ƒ
    static func shareImage(_ image: UIImage, from sourceRect: CGRect, in sourceView: UIView, completion: @escaping () -> Void) {
        let items: [Any] = [image]
        let activityVC = UIActivityViewController(activityItems: items, applicationActivities: nil)
        
        // é…ç½®iPadä¸Šçš„å¼¹å‡ºæ¡†ä½ç½®
        if let popoverController = activityVC.popoverPresentationController {
            popoverController.sourceRect = sourceRect
            popoverController.sourceView = sourceView
        }
        
        // å¯»æ‰¾å½“å‰è§†å›¾æ§åˆ¶å™¨å¹¶æ˜¾ç¤ºåˆ†äº«ç•Œé¢
        if let windowScene = UIApplication.shared.connectedScenes.first as? UIWindowScene,
           let rootVC = windowScene.windows.first?.rootViewController {
            var currentVC = rootVC
            while let presentedVC = currentVC.presentedViewController {
                currentVC = presentedVC
            }
            
            currentVC.present(activityVC, animated: true)
            
            // è®¾ç½®åˆ†äº«å®Œæˆçš„å›è°ƒ
            activityVC.completionWithItemsHandler = { _, _, _, _ in
                completion()
            }
        }
    }
    
    /// åˆ›å»ºä¸€ä¸ªåˆ†äº«æµ·æŠ¥å¹¶æ˜¾ç¤ºåˆ†äº«ç•Œé¢
    /// - Parameters:
    ///   - isUserLoggedIn: ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
    ///   - userName: ç”¨æˆ·åç§°
    ///   - userAvatar: ç”¨æˆ·å¤´åƒ
    ///   - goal: ç›®æ ‡å¯¹è±¡ï¼Œç”¨äºç”Ÿæˆæµ·æŠ¥å†…å®¹
    ///   - contentView: è‡ªå®šä¹‰å†…å®¹è§†å›¾ï¼Œå¦‚æœæä¾›åˆ™ä¼˜å…ˆä½¿ç”¨æ­¤è§†å›¾è€Œä¸æ˜¯goal
    ///   - sourceRect: åˆ†äº«å¼¹å‡ºæ¡†çš„æ¥æºä½ç½®
    ///   - sourceView: åˆ†äº«å¼¹å‡ºæ¡†çš„æ¥æºè§†å›¾
    ///   - completion: åˆ†äº«å®Œæˆåçš„å›è°ƒ
    static func sharePoster(
        isUserLoggedIn: Bool,
        userName: String? = nil,
        userAvatar: UIImage? = nil,
        goal: Goal? = nil,
        contentView: AnyView? = nil,
        from sourceRect: CGRect,
        in sourceView: UIView,
        completion: @escaping () -> Void
    ) {
        // åˆ›å»ºæµ·æŠ¥è§†å›¾
        let posterView = SharePosterView(
            isUserLoggedIn: isUserLoggedIn,
            userName: userName,
            userAvatar: userAvatar,
            goal: goal,
            contentView: contentView
        )
        
        // ç”Ÿæˆå›¾ç‰‡ï¼Œä½¿ç”¨è‡ªé€‚åº”é«˜åº¦
        if let image = generateImage(from: posterView) {
            // æ˜¾ç¤ºåˆ†äº«ç•Œé¢
            shareImage(image, from: sourceRect, in: sourceView, completion: completion)
        } else {
            // å›¾ç‰‡ç”Ÿæˆå¤±è´¥
            completion()
        }
    }
} 