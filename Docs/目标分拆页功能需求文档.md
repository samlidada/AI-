# 目标分拆页功能需求文档

## 1. 功能概述

目标分拆页是应用的核心功能页面，用于将用户的大目标智能拆分为可执行的小目标，并提供进度追踪、成果上传和评分反馈功能。

## 2. 页面结构

目标分拆页分为以下几个主要部分：
1. 总目标信息区
   - 目标标题和描述
   - 目标设立时间
   - 目标执行状态
   - 目标完成所需总时间/倒计时
2. 智能分解功能区
   - 智能分解按钮
   - 刷新方案按钮
   - 编辑模式切换
3. 小目标列表区
   - 小目标内容
   - 小目标完成所需时间/倒计时
   - 小目标状态指示器
   - 成果上传框（执行阶段）
4. 操作按钮区
   - 开始执行按钮
   - 完成按钮

## 3. 功能流程

### 3.1 规划阶段

1. **初始状态**
   - 用户进入目标分拆页
   - 显示总目标信息（标题、描述、设立时间、状态）
   - 仅显示"智能分解"按钮

2. **智能分解**
   - 用户点击"智能分解"按钮
   - AI分析并生成小目标列表
   - 显示完成总目标所需的总时间
   - 每个小目标显示其完成所需的时间
   - 出现"刷新方案"按钮和"编辑"按钮
   - 出现"开始执行"按钮

3. **方案编辑**
   - 用户可以点击"编辑"按钮进入编辑模式
   - 编辑模式允许：
     - 编辑小目标内容
     - 删除小目标
     - 添加新小目标
     - 调整小目标顺序
   - 在编辑模式下，"刷新方案"按钮仍可使用
   - 点击"刷新方案"将覆盖所有用户编辑的内容

4. **确认方案**
   - 用户完成编辑后，点击"完成编辑"返回正常模式
   - "开始执行"按钮变为可用状态

### 3.2 执行阶段

1. **开始执行**
   - 用户点击"开始执行"按钮
   - 所有目标内容被锁定（无法编辑）
   - "刷新方案"和"编辑"按钮消失
   - 总目标的时间显示变为倒计时
   - 第一个小目标的时间显示变为倒计时
   - 其他小目标显示"等待执行"状态

2. **任务执行过程**
   - 当前执行的小目标显示倒计时，并出现成果上传框
   - 用户上传成果并点击"完成"按钮后：
     - 当前小目标状态变为"已完成"
     - 自动激活下一个小目标
     - 下一个小目标的倒计时开始
   - 总目标的倒计时继续进行（不会因提前完成小目标而减少）

3. **执行完成**
   - 当最后一个小目标完成后：
     - 倒计时自动结束
     - 时间显示恢复为"总目标所需时间"
     - 状态根据完成时间更新：
       - 提前完成：距倒计时结束还有总时间的30%以上
       - 按时完成：距倒计时结束还有总时间的30%以内
       - 未能完成：倒计时结束后完成

### 3.3 评估阶段

1. **评估生成**
   - 所有小目标完成或倒计时结束后，内容被锁定
   - AI自动生成评分和评语
   - 显示评分结果和详细反馈

## 4. 状态规则

1. **目标执行状态** (`GoalExecutionStatus`):
   - `planning`：规划中，初始创建时的状态，可编辑
   - `executing`：执行中，点击"开始执行"后，锁定编辑，开始倒计时
   - `evaluating`：评估中，所有小目标完成或总倒计时结束
   - `completed`：已完成，评估完成后的状态

2. **目标状态** (`GoalStatus`):
   - `notStarted`：未开始
   - `inProgress`：进行中
   - `completed`：已完成
   - `overdue`：未按时完成

3. **子任务状态** (`SubTaskStatus`): 需要添加的新枚举
   - `waiting`：等待执行，前序任务未完成
   - `active`：当前激活，正在执行中
   - `completed`：已完成
   - `overdue`：未在预计时间内完成

4. **完成评估状态**:
   - `提前完成`：距倒计时结束还有总时间的30%以上完成
   - `按时完成`：距倒计时结束还有总时间的30%以内完成
   - `未能完成`：倒计时结束时未完成

## 5. 交互限制

1. 在规划阶段：
   - 用户可以自由编辑和刷新AI方案
   - 用户可以随时点击"开始执行"进入执行阶段

2. 在执行阶段：
   - 小目标按顺序激活，一次只有一个处于活跃状态
   - 用户不能编辑目标内容
   - 用户必须上传成果才能完成小目标

3. 在评估阶段：
   - 用户不能再修改任何内容
   - 只能查看评分和反馈

## 6. 数据结构要求

1. **Goal模型扩展**:
   - `executionStatus`: 执行状态枚举（规划中、执行中、评估中、已完成）- 已实现
   - `isLocked`: 是否锁定编辑 - 已实现
   - `startExecutionDate`: 开始执行时间 - 已实现
   - `aiScore`: AI评分 - 已实现
   - `aiComment`: AI评语 - 已实现
   - `totalEstimatedDays`: 总预计完成天数（根据子任务计算）- 需要添加

2. **SubTask模型扩展**:
   - `order`: 执行顺序 - 已实现
   - `estimatedDays`: 预计完成天数 - 已实现
   - `status`: 子任务状态枚举（等待执行、当前激活、已完成、逾期）- 需要添加
   - `startDate`: 开始执行的日期 - 需要添加
   - `isActive`: 是否是当前活跃的任务 - 需要添加
   - 通过`CompletionProof`关联完成证明 - 模型已存在，需关联

3. **CompletionProof模型**:
   - 已实现基本结构，包含图片数据、描述和上传日期
   - 需扩展支持多种格式的证明（文本、图片、文件等）

## 7. UI设计与交互详情

### 7.1 页面布局

1. **总目标信息区**
   - 置于页面顶部，占据页面宽度的90%
   - 包含目标标题（大字体，粗体）、描述（中等字体，常规）
   - 右侧显示目标状态标签（颜色标识不同状态）
   - 下方显示创建时间和预计总完成时间/倒计时

2. **功能按钮区**
   - 位于总目标信息区下方
   - 初始状态只显示"智能分解"按钮（蓝色，居中）
   - 分解后显示"刷新方案"、"编辑"和"开始执行"按钮（横向排列）
   - 执行阶段隐藏"刷新方案"和"编辑"按钮

3. **子任务列表区**
   - 占据页面主体部分，可滚动
   - 每个子任务为一个卡片式条目，包含：
     - 子任务标题和内容
     - 任务状态指示器（图标+文字）
     - 预计完成时间/倒计时
     - 执行阶段显示成果上传按钮/已上传指示
   - 编辑模式下显示拖动手柄、删除按钮和编辑图标

4. **评估结果区**
   - 完成阶段显示在子任务列表下方
   - 包含总评分（星级显示）和评语（文本框）

### 7.2 交互设计

1. **智能分解交互**
   - 点击按钮后显示加载动画
   - 分解完成后使用动画效果显示生成的子任务

2. **编辑模式交互**
   - 点击"编辑"按钮切换到编辑模式
   - 子任务可通过拖拽重新排序
   - 点击子任务显示编辑界面（弹出框或内嵌编辑）
   - 列表底部显示"添加子任务"按钮
   - 退出编辑模式前提示保存更改

3. **执行阶段交互**
   - 活跃子任务高亮显示，其他任务半透明
   - 当前子任务展开显示成果上传区域
   - 上传成果支持图片选择/拍照功能
   - 完成按钮点击后显示确认对话框

4. **评估显示**
   - 评分结果使用动画效果揭示
   - 评语采用打字机效果逐字显示

## 8. 数据流与业务逻辑

1. **目标分解流程**
   - 前端发送目标信息至AI服务
   - AI分析目标，生成子任务列表和时间估计
   - 返回数据保存至数据库，并更新UI

2. **执行状态追踪**
   - 开始执行时记录初始时间，计算每个子任务的开始和结束时间
   - 定时检查当前进度，更新倒计时显示
   - 子任务完成时自动切换到下一任务

3. **评分计算逻辑**
   - 基于完成时间占比计算时效性得分
   - 基于成果质量（上传证明）计算完成质量得分
   - 两项得分加权平均得出最终评分

## 9. 与现有代码的对接方案

1. **模型扩展**
   - 在`SubTask.swift`中添加新的状态枚举`SubTaskStatus`
   - 扩展`SubTask`类，添加`status`、`startDate`和`isActive`属性
   - 扩展`Goal`类，添加`totalEstimatedDays`计算属性

2. **视图组件**
   - 在`Views`目录下创建新的`GoalBreakdownView.swift`作为目标分拆主页面
   - 创建`SubTaskItemView.swift`作为子任务条目组件
   - 创建`ProofUploadView.swift`作为成果上传组件

3. **ViewModel扩展**
   - 在`GoalViewModel.swift`中添加子任务管理方法：
     - `generateSubTasks(for goal: Goal) -> [SubTask]`：AI生成子任务
     - `refreshSubTasksPlan(for goal: Goal)`：刷新子任务方案
     - `activateNextSubTask(for goal: Goal)`：激活下一个子任务
     - `uploadProof(for subTask: SubTask, proof: CompletionProof)`：上传成果
     - `evaluateGoal(goal: Goal) -> (score: Int, comment: String)`：评估目标

## 10. 注意事项

1. 总目标倒计时与小目标倒计时是独立的，小目标提前完成不会影响总目标倒计时
2. 当进入执行阶段后，不能返回规划阶段（不可撤销）
3. 所有目标锁定后不能编辑内容，确保数据的一致性
4. 目标评分计算需考虑完成及时性、完成质量（基于上传成果）等因素
5. 当前代码库中的模型结构已经部分实现了需求中的数据结构，在实现时需要注意与现有结构的兼容性
6. 页面过渡和状态变化时使用适当的动画效果，提升用户体验
7. 考虑添加本地通知功能，在子任务即将到期时提醒用户 