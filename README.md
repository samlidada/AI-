# AI目标拆解应用

## 产品概述

AI目标拆解是一款智能化目标管理应用，通过AI技术帮助用户将复杂目标拆分为可执行的子目标，提供时间规划、进度追踪和评估功能。应用全程陪伴用户从目标制定、任务拆解、执行追踪到最终评估的完整流程。

### 核心功能

- **目标录入与AI拆解**：用户输入目标名称、描述、优先级和截止日期，AI智能拆解为可执行子目标
- **子目标编辑与管理**：调整子目标内容、顺序和依赖关系，通过可视化方式展示任务间关系
- **任务执行与追踪**：追踪子目标完成情况，及时提醒，自动计算总体进度，实时倒计时
- **成果证明与上传**：记录子任务完成的证明材料，支持多图片上传和文字说明
- **评分与反馈**：基于完成度、时效性和成果质量进行评分，提供个性化建议
- **数据分析**：提供用户历史目标完成情况的统计和分析

## 当前版本功能

- 目标创建、编辑和删除
- 按日期分组查看目标
- 目标倒计时和状态显示
- 基础搜索功能
- AI目标拆解功能
- 子目标管理（添加、编辑、完成、删除）
- 子目标拖拽排序
- 子目标时间估算
- 目标执行模式
- 实时倒计时追踪
- 子任务证明上传（多图片）
- 目标进度追踪
- AI评估和评分
- 基于实际完成情况的目标状态显示（未按时完成状态）
- 目标删除权限控制（仅允许删除"未开始"状态的目标）
- 数据分析和统计（按时间范围统计目标完成情况、状态分布、效率分析和个性化洞察）
- 个性化分享海报
  - 展示用户头像和信息
  - 完整显示目标和子任务内容
  - 动态彩色进度圈显示子任务完成用时比例
  - 精确统计和展示各任务实际用时（分钟级）
  - 支持虚线连接和自定义样式
  - 响应式布局适应不同内容量
- 子任务成果查看功能优化
  - 任何阶段（规划、执行、评估、完成）均可查看已完成子任务的成果证明
  - 维持界面一致性，确保用户体验流畅
  - 简化历史成果的回顾流程
- 单一子任务删除保护
  - 防止用户删除目标中唯一的子任务导致执行错误
  - 在子任务数量为1时，隐藏编辑模式按钮
  - 增强应用稳定性和用户体验
- 数据分析改进
  - 优化执行效率分析，聚焦父目标的整体分析
  - 新增目标创建频率和间隔分析指标
  - 提供基于目标设定习惯的个性化洞察
- 自定义启动屏幕
  - 精美的全屏启动页面设计
  - 平滑的过渡动画效果
  - 加载指示器和状态提示
  - 支持深色/浅色模式自适应

## 待开发功能

- 数据导出与分享
- 通知提醒系统
- 目标模板功能
- 云端同步

## 技术架构

- **框架**: 使用SwiftUI构建现代化UI界面
- **数据持久化**: 采用SwiftData进行本地数据管理
- **架构模式**: 遵循MVVM架构模式，清晰分离数据、业务逻辑和UI
- **响应式编程**: 使用Combine框架进行数据流管理
- **后台处理**: 支持应用进入后台时继续计时
- **AI服务**: 集成通义千问大语言模型API，通过智能分析和评估提供决策支持
- **图片处理**: 支持多图片上传和存储
- **启动体验**: 使用纯代码方式实现自定义启动屏幕，提供平滑过渡效果

## 上架准备清单

### 必备资源
- ✅ 应用图标 (AppIcon): 已完成1024x1024像素主图标及深色/浅色变体
- ✅ 启动屏幕 (LaunchScreen): 已完成自定义启动页面
- ⬜ 应用截图: 需为不同设备准备5-8张高质量截图
- ⬜ 应用预览视频: 推荐制作30秒应用功能演示视频
- ⬜ 隐私政策: 需创建符合App Store要求的隐私政策

### 应用配置
- ✅ 应用名称和Bundle ID配置
- ✅ 版本号和构建号设置
- ✅ 部署目标和设备支持配置
- ⬜ 权限描述配置 (相机、相册等)
- ⬜ App Transport Security设置

### App Store Connect设置
- ⬜ 创建应用记录
- ⬜ 设置价格和可用区域
- ⬜ 添加App内购买项目(如需)
- ⬜ 配置年龄分级
- ⬜ 准备审核信息和测试账号

### 审核准备
- ⬜ 移除测试代码和日志
- ⬜ 确保没有崩溃和性能问题
- ⬜ 测试所有功能在不同设备上的表现
- ⬜ 准备审核说明和演示视频

## AI服务架构

应用集成了通义千问大语言模型API，通过灵活的服务架构实现AI功能：

### 服务层次结构

1. **基础服务类 (AIService)**
   - 定义通用的消息结构和请求接口
   - 提供同步和异步API访问方法
   - 实现错误处理和请求转换逻辑

2. **API实现服务 (SiliconFlowAPIService)**
   - 继承自AIService，实现具体API调用
   - 支持多模型自动切换和错误恢复机制
   - 提供完整的日志记录和请求跟踪
   - 实现自动重试和优雅的错误处理

3. **业务服务 (AIGoalAnalysisService)**
   - 提供特定业务功能（目标分析、子任务生成、目标评估）
   - 处理AI响应解析和数据转换
   - 实现本地备份生成机制，确保功能稳定性

### 核心功能

- **多模型支持**: 自动在多个AI模型之间切换，提高成功率
- **完整日志系统**: 记录所有API请求和响应，便于调试和分析
- **错误处理策略**: 多层次错误处理确保应用稳定性
- **离线备份方案**: 当API不可用时提供本地生成的替代方案
- **异步操作支持**: 使用Swift并发特性提供流畅的用户体验

### API错误类型

系统定义了完整的错误类型体系，确保错误处理的精确性：

- **invalidURL**: URL格式不正确
- **requestEncodingFailed**: 请求编码失败
- **responseDecodingFailed**: 响应解码失败
- **noDataReceived**: 未收到数据
- **invalidResponseFormat**: 响应格式无效
- **apiError**: API返回的错误信息
- **httpError**: HTTP状态码错误
- **allModelsFailedError**: 所有模型都尝试失败

## 项目结构

```
AI目标拆解应用
│
├── Models/ - 数据模型
│   ├── Goal.swift - 目标模型
│   ├── SubTask.swift - 子任务模型
│   └── CompletionProof.swift - 任务完成证明模型
│
├── Views/ - 视图层
│   ├── Goals/ - 目标相关视图
│   │   ├── GoalDetailView.swift - 目标详情视图
│   │   ├── GoalExecutionView.swift - 目标执行视图
│   │   ├── GoalEditView.swift - 目标编辑视图
│   │   └── GoalEvaluationView.swift - 目标评估视图
│   ├── Common/ - 通用视图组件
│   ├── Menu/ - 菜单相关视图
│   └── DataAnalysisView.swift - 数据分析视图
│
├── ViewModels/ - 视图模型
│   ├── GoalViewModel.swift - 目标视图模型
│   └── AnalyticsViewModel.swift - 数据分析视图模型
│
├── Services/ - 服务层
│   ├── ServicesManager.swift - 服务管理器
│   ├── AIGoalAnalysisService.swift - AI目标分析服务
│   └── AIService/ - AI服务接口
│       ├── AIService.swift - AI服务基类
│       └── SiliconFlowAPIService.swift - 通义千问API服务实现
│
├── Utils/ - 工具类
│   ├── TimerManager.swift - 定时器管理器
│   └── Extensions/ - 扩展方法
│
├── Migrations/ - 数据迁移
│
├── Assets.xcassets/ - 资源文件
│   ├── AppIcon.appiconset/ - 应用图标
│   ├── LaunchImage.imageset/ - 启动屏幕图片
│   └── AccentColor.colorset/ - 强调色
│
├── ProjectApp.swift - 应用入口
└── ContentView.swift - 主内容视图
```

## 架构图

```
┌───────────────────────────────────────────────────────────────────────┐
│                                用户界面                                │
└───────────────┬───────────────────────────────────┬───────────────────┘
                │                                   │
                ▼                                   ▼
┌────────────────────────────┐        ┌────────────────────────────┐
│          Views 层          │        │        UIKit 组件          │
│ - ContentView              │        │ - UIImagePickerController  │
│ - GoalDetailView           │        └────────────────────────────┘
│ - GoalExecutionView        │
│ - GoalEditView             │
│ - GoalEvaluationView       │
│ - DataAnalysisView         │
└────────────┬───────────────┘
             │
             ▼
┌────────────────────────────┐        ┌────────────────────────────┐
│       ViewModels 层        │◄───────┤         Services 层        │
│ - GoalViewModel            │        │ - AIGoalAnalysisService    │
│ - AnalyticsViewModel       │        │ - AIService                │
└────────────┬───────────────┘        │ - SiliconFlowAPIService    │
             │                        └────────────────────────────┘
             │                                     ▲
             ▼                                     │
┌────────────────────────────┐        ┌────────────────────────────┐
│         Models 层          │        │         Utils 层           │
│ - Goal                     │◄───────┤ - TimerManager             │
│ - SubTask                  │        │ - Extensions               │
│ - CompletionProof          │        └────────────────────────────┘
└────────────┬───────────────┘
             │
             ▼
┌────────────────────────────┐
│        数据持久化           │
│     SwiftData / SQLite     │
└────────────────────────────┘
```

## AI服务流程图

```
┌───────────────────┐
│                   │
│    用户操作请求     │
│                   │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐         ┌───────────────────┐
│                   │         │                   │
│ AIGoalAnalysis    │─────────▶ SiliconFlowAPI    │
│  Service          │         │  Service          │
│                   │         │                   │
└─────────┬─────────┘         └─────────┬─────────┘
          │                             │
          │                             ▼
          │                   ┌───────────────────┐
          │                   │                   │
          │                   │  多模型尝试循环     │
          │                   │                   │
          │                   └─────────┬─────────┘
          │                             │
          │                             ▼
┌─────────┴─────────┐         ┌───────────────────┐
│                   │   否     │                   │
│  API调用成功？     │◀────────│   尝试所有模型      │
│                   │         │                   │
└─────────┬─────────┘         └───────────────────┘
          │ 是                          ▲
          ▼                             │
┌───────────────────┐                   │
│                   │                   │
│   解析API响应      │                   │
│                   │                   │
└─────────┬─────────┘                   │
          │                             │
          ▼                             │
┌───────────────────┐         ┌───────────────────┐
│                   │   否     │                   │
│ 解析成功？         │─────────▶│    本地生成        │
│                   │         │    数据           │
└─────────┬─────────┘         └─────────┬─────────┘
          │ 是                          │
          ▼                             │
┌───────────────────┐                   │
│                   │                   │
│   返回结果给用户    │◀──────────────────┘
│                   │
└───────────────────┘
```

## 数据流向图

```
┌─────────────┐     ┌────────────────┐     ┌─────────────┐
│             │     │                │     │             │
│   用户操作   │────▶│  Views (SwiftUI) │────▶│ 界面更新    │
│             │     │                │     │             │
└─────────────┘     └───────┬────────┘     └─────────────┘
                            │
                            │ 用户行为
                            ▼
                    ┌────────────────┐     ┌─────────────┐
                    │                │     │             │
                    │   ViewModels   │────▶│ 服务请求     │
                    │                │     │             │
                    └───────┬────────┘     └──────┬──────┘
                            │                     │
              数据绑定/行为响应│                     │服务响应
                            │                     │
                            ▼                     ▼
                    ┌────────────────┐     ┌─────────────┐
                    │                │     │             │
                    │    Models     │◀────┤  Services   │
                    │                │     │             │
                    └───────┬────────┘     └─────────────┘
                            │
                            │ 数据更新
                            ▼
                    ┌────────────────┐
                    │                │
                    │   SwiftData    │
                    │                │
                    └────────────────┘
```

## 数据模型

### 目标状态流转

目标具有两种状态体系：
1. **目标状态** (`GoalStatus`):
   - `notStarted`: 未开始
   - `inProgress`: 进行中
   - `completed`: 已完成
   - `overdue`: 未按时完成

2. **执行状态** (`GoalExecutionStatus`):
   - `planning`: 规划中，可编辑子任务
   - `executing`: 执行中，锁定编辑，开始计时
   - `evaluating`: 评估中，AI分析执行情况
   - `completed`: 已完成，展示最终评分和建议

### 模型关系图

```
┌───────────────────────┐       ┌───────────────────────┐
│         Goal          │       │       SubTask         │
├───────────────────────┤       ├───────────────────────┤
│ id: UUID              │       │ id: UUID              │
│ title: String         │       │ title: String         │
│ description: String   │       │ isCompleted: Bool     │
│ status: GoalStatus    │◄──1:n─┤ goal: Goal            │
│ executionStatus       │       │ order: Int            │
│ priority: GoalPriority│       │ estimatedDays: Int    │
│ createdDate: Date     │       │ remainingTime: Int?   │
│ targetDate: Date?     │       └─────────┬─────────────┘
│ completedDate: Date?  │                 │
│ startExecutionDate    │                 │ 1:n
│ isLocked: Bool        │                 │
│ aiScore: Int?         │                 ▼
│ aiComment: String?    │       ┌───────────────────────┐
└───────────────────────┘       │    CompletionProof    │
                                ├───────────────────────┤
                                │ id: UUID              │
                                │ imageData: Data       │
                                │ proofDescription      │
                                │ uploadDate: Date      │
                                │ subTask: SubTask      │
                                │                       │
                                │                       │
                                └─────────┬─────────────┘
                                          │
                                          │ 1:n
                                          ▼
                                ┌───────────────────────┐
                                │     ProofImage        │
                                ├───────────────────────┤
                                │ id: UUID              │
                                │ imageData: Data       │
                                │ uploadDate: Date      │
                                └───────────────────────┘
```

## 用户界面流程

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│             │     │             │     │             │
│  目标清单    │────▶│  目标详情    │────▶│  目标执行    │
│   页面      │     │   页面      │     │   页面      │
│             │     │             │     │             │
└─────────────┘     └─────────────┘     └─────┬───────┘
      │                                       │
      │                                       │
      ▼                                       ▼
┌─────────────┐                       ┌─────────────┐
│             │                       │             │
│  目标添加    │                       │  目标评估    │
│   页面      │                       │   页面      │
│             │                       │             │
└─────────────┘                       └─────────────┘
```

## 启动流程

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│             │     │             │     │             │
│ 点击应用图标  │────▶│ 显示启动屏幕  │────▶│  加载应用    │
│             │     │             │     │   数据      │
│             │     │             │     │             │
└─────────────┘     └─────────────┘     └─────┬───────┘
                                               │
                                               │
                                               ▼
                                        ┌─────────────┐
                                        │             │
                                        │ 平滑过渡到   │
                                        │ 主界面      │
                                        │             │
                                        └─────────────┘
```

## 数据分析流程

```
                        ┌─────────────────┐
                        │                 │
                        │  数据分析页面    │
                        │                 │
                        └────────┬────────┘
                                 │
                                 │ 选择时间范围
                                 ▼
          ┌─────────────────────────────────────┐
          │         AnalyticsViewModel          │
          └───┬─────────────┬──────────┬────────┘
              │             │          │
              ▼             ▼          ▼
  ┌─────────────────┐ ┌──────────┐ ┌────────────┐
  │  目标统计数据    │ │ 趋势分析  │ │ 状态分布   │
  └────────┬────────┘ └────┬─────┘ └─────┬──────┘
           │                │             │
           ▼                ▼             ▼
  ┌─────────────────┐ ┌──────────┐ ┌────────────┐
  │   统计卡片视图   │ │ 趋势图表  │ │ 饼图视图   │
  └─────────────────┘ └──────────┘ └────────────┘
```

## 使用说明

1. **创建目标**：点击主页面底部"+"按钮，输入目标信息
2. **目标拆解**：进入目标详情页，点击"AI智能分解"按钮，获取子任务列表
3. **编辑子任务**：可添加、删除、调整子任务内容和顺序
4. **开始执行**：点击"开始执行"按钮，进入执行模式
5. **任务倒计时**：每个子任务都有倒计时，按顺序执行
6. **上传证明**：完成子任务后上传证明图片和说明
7. **完成评估**：所有子任务完成后，自动进入AI评估阶段，获取评分和反馈
8. **查看历史**：在主页面查看所有历史目标及其完成状态
9. **数据分析**：从菜单中选择"数据分析"，查看目标完成统计和个性化洞察
   - 可选择周/月/年时间范围查看不同时期的数据
   - 下拉刷新获取最新分析
   - 查看目标完成趋势、状态分布和执行效率分析
   - 获取基于历史数据的个性化建议

## 开发者说明

- 使用SwiftData迁移助手处理数据模型变更
- GoalExecutionStatus和GoalStatus共同决定目标在UI中的显示状态
- TimerManager负责处理应用在前台和后台的倒计时管理
- 视图大小超过1000行时考虑拆分为子视图组件
- 所有视图应遵循MVVM模式，避免在视图中直接修改模型
- 每个模块之间通过明确的接口进行通信，避免循环依赖 